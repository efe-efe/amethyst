local ____lualib = require("lualib_bundle")
local __TS__InstanceOf = ____lualib.__TS__InstanceOf
local __TS__ArraySome = ____lualib.__TS__ArraySome
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["7"] = 1,["8"] = 2,["9"] = 3,["10"] = 4,["11"] = 6,["12"] = 6,["13"] = 7,["14"] = 7,["15"] = 8,["16"] = 8,["17"] = 9,["18"] = 9,["19"] = 10,["20"] = 10,["21"] = 11,["22"] = 11,["23"] = 12,["24"] = 12,["25"] = 96,["26"] = 97,["27"] = 99,["28"] = 99,["29"] = 99,["30"] = 99,["31"] = 99,["32"] = 99,["33"] = 99,["34"] = 99,["35"] = 99,["36"] = 99,["37"] = 99,["38"] = 99,["39"] = 96,["40"] = 115,["41"] = 116,["42"] = 117,["43"] = 119,["44"] = 119,["45"] = 119,["46"] = 119,["47"] = 119,["48"] = 119,["49"] = 119,["50"] = 119,["51"] = 115,["52"] = 134,["53"] = 138,["55"] = 134,["56"] = 143,["57"] = 145,["58"] = 143,["59"] = 177,["60"] = 182,["61"] = 182,["62"] = 182,["63"] = 182,["64"] = 182,["65"] = 182,["66"] = 184,["67"] = 185,["69"] = 177,["70"] = 14,["71"] = 15,["72"] = 14,["73"] = 19,["74"] = 20,["76"] = 22,["77"] = 22,["78"] = 23,["79"] = 25,["80"] = 27,["82"] = 22,["86"] = 19,["87"] = 34,["88"] = 35,["89"] = 36,["90"] = 38,["91"] = 39,["93"] = 43,["94"] = 43,["95"] = 43,["96"] = 43,["97"] = 43,["98"] = 43,["99"] = 43,["100"] = 43,["101"] = 43,["102"] = 43,["103"] = 43,["104"] = 66,["105"] = 66,["106"] = 66,["107"] = 66,["108"] = 66,["110"] = 68,["113"] = 72,["114"] = 72,["115"] = 72,["116"] = 72,["117"] = 72,["118"] = 72,["119"] = 72,["120"] = 82,["121"] = 82,["122"] = 82,["123"] = 82,["124"] = 82,["126"] = 34,["127"] = 86,["128"] = 87,["129"] = 88,["131"] = 90,["132"] = 91,["134"] = 93,["135"] = 86,["136"] = 108,["137"] = 109,["138"] = 110,["139"] = 112,["140"] = 112,["141"] = 112,["142"] = 112,["143"] = 112,["144"] = 112,["145"] = 112,["146"] = 112,["147"] = 108,["148"] = 122,["149"] = 123,["150"] = 124,["151"] = 126,["152"] = 126,["153"] = 126,["154"] = 126,["155"] = 126,["156"] = 126,["157"] = 126,["158"] = 126,["159"] = 122,["160"] = 129,["161"] = 131,["162"] = 129,["163"] = 148,["164"] = 153,["165"] = 154,["167"] = 157,["168"] = 159,["169"] = 160,["171"] = 162,["172"] = 163,["174"] = 148,["175"] = 167,["176"] = 168,["177"] = 169,["178"] = 169,["179"] = 169,["180"] = 169,["181"] = 169,["182"] = 169,["183"] = 169,["184"] = 167,["185"] = 172,["186"] = 173,["187"] = 174,["188"] = 174,["189"] = 174,["190"] = 174,["191"] = 174,["192"] = 174,["193"] = 174,["194"] = 172,["195"] = 189,["196"] = 189,["197"] = 189,["199"] = 190,["200"] = 190,["201"] = 190,["202"] = 190,["203"] = 190,["204"] = 190,["205"] = 190,["206"] = 191,["207"] = 191,["208"] = 191,["209"] = 191,["210"] = 191,["211"] = 191,["212"] = 191,["213"] = 193,["215"] = 189,["216"] = 198,["217"] = 198,["218"] = 198,["220"] = 199,["221"] = 199,["222"] = 199,["223"] = 199,["224"] = 199,["225"] = 199,["226"] = 199,["227"] = 200,["228"] = 200,["229"] = 200,["230"] = 200,["231"] = 200,["232"] = 200,["233"] = 200,["234"] = 202,["236"] = 198,["237"] = 207,["238"] = 208,["239"] = 210,["240"] = 215,["241"] = 215,["242"] = 215,["243"] = 215,["244"] = 215,["245"] = 215,["246"] = 215,["247"] = 215,["248"] = 215,["249"] = 216,["250"] = 207,["251"] = 219,["252"] = 220,["253"] = 221,["254"] = 222,["255"] = 224,["256"] = 225,["258"] = 228,["259"] = 229,["261"] = 232,["262"] = 219,["263"] = 235,["264"] = 236,["265"] = 235,["266"] = 239,["267"] = 240,["268"] = 243,["269"] = 243,["270"] = 243,["271"] = 243,["272"] = 243,["273"] = 243,["274"] = 243,["275"] = 243,["276"] = 243,["277"] = 243,["278"] = 249,["279"] = 250,["280"] = 251,["281"] = 251,["282"] = 251,["283"] = 251,["284"] = 251,["286"] = 254,["287"] = 256,["288"] = 260,["289"] = 261,["290"] = 261,["291"] = 261,["292"] = 261,["293"] = 261,["294"] = 261,["295"] = 261,["297"] = 239,["298"] = 265,["299"] = 266,["300"] = 265,["301"] = 269,["302"] = 270,["303"] = 269,["304"] = 273,["305"] = 274,["306"] = 273,["307"] = 277,["308"] = 278,["309"] = 278,["310"] = 278,["311"] = 278,["312"] = 277,["313"] = 281,["314"] = 288,["315"] = 289,["316"] = 290,["317"] = 304,["318"] = 304,["319"] = 304,["320"] = 304,["321"] = 304,["322"] = 304,["323"] = 304,["324"] = 281,["325"] = 313,["328"] = 317,["331"] = 315,["337"] = 313,["338"] = 321,["339"] = 322,["340"] = 324,["341"] = 328,["344"] = 332,["345"] = 321,["346"] = 335,["347"] = 336,["348"] = 337,["349"] = 338,["351"] = 335,["352"] = 342,["353"] = 343,["354"] = 343,["355"] = 343,["356"] = 343,["357"] = 343,["358"] = 343,["359"] = 343,["360"] = 342,["361"] = 346,["362"] = 347,["363"] = 346,["364"] = 350,["365"] = 351,["366"] = 350,["367"] = 354,["368"] = 355,["369"] = 356,["370"] = 356,["371"] = 356,["372"] = 356,["373"] = 356,["374"] = 357,["375"] = 358,["376"] = 358,["377"] = 358,["378"] = 358,["379"] = 358,["380"] = 359,["381"] = 354,["382"] = 362,["383"] = 363,["384"] = 364,["385"] = 366,["386"] = 367,["387"] = 368,["388"] = 369,["389"] = 370,["390"] = 370,["391"] = 370,["392"] = 370,["393"] = 370,["394"] = 370,["395"] = 370,["396"] = 370,["401"] = 382,["402"] = 382,["403"] = 383,["404"] = 383,["405"] = 383,["406"] = 383,["407"] = 383,["408"] = 382,["409"] = 382,["410"] = 382,["411"] = 382,["412"] = 382,["413"] = 382,["414"] = 362,["415"] = 396,["416"] = 397,["417"] = 396,["418"] = 401,["419"] = 409,["420"] = 416,["421"] = 401,["422"] = 425,["423"] = 426,["424"] = 425,["425"] = 431,["426"] = 432,["427"] = 433,["429"] = 435,["430"] = 436,["431"] = 437,["432"] = 438,["434"] = 431});
local ____exports = {}
local ____custom_modifier = require("abilities.framework.custom_modifier")
local CustomModifierMotionBoth = ____custom_modifier.CustomModifierMotionBoth
local CustomModifierMotionHorizontal = ____custom_modifier.CustomModifierMotionHorizontal
local CustomModifierMotionVertical = ____custom_modifier.CustomModifierMotionVertical
local ____modifier_counter = require("modifiers.modifier_counter")
local ModifierCounter = ____modifier_counter.ModifierCounter
local ____modifier_gem = require("modifiers.modifier_gem")
local ModifierGem = ____modifier_gem.ModifierGem
local ____modifier_hide_bar = require("modifiers.modifier_hide_bar")
local ModifierHideBar = ____modifier_hide_bar.ModifierHideBar
local ____modifier_obstacle = require("modifiers.modifier_obstacle")
local ModifierObstacle = ____modifier_obstacle.ModifierObstacle
local ____modifier_radius_marker = require("modifiers.modifier_radius_marker")
local ModifierRadiusMarker = ____modifier_radius_marker.ModifierRadiusMarker
local ____modifier_recast = require("modifiers.modifier_recast")
local ModifierRecast = ____modifier_recast.ModifierRecast
local ____modifier_wall = require("modifiers.modifier_wall")
local ModifierWall = ____modifier_wall.ModifierWall
function ____exports.overheadMessageEFX(self, unit, value, wordLength, color, shield)
    local duration = math.max(1, value / 10)
    EFX(
        "particles/msg_damage.vpcf",
        PATTACH_WORLDORIGIN,
        nil,
        {
            cp0 = unit:GetAbsOrigin(),
            cp1 = Vector(0, value, shield),
            cp2 = Vector(duration, wordLength, 0),
            cp3 = color,
            release = true
        }
    )
end
function ____exports.sendOverheadEnergyMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(255, 243, 140)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        0
    )
end
function ____exports.setEnergy(self, unit, amount, informClient)
    if informClient then
    end
end
function ____exports.getEnergy(self, unit)
    return 0
end
function ____exports.giveEnergy(self, unit, amount, informClient, showOverhead)
    ____exports.setEnergy(
        nil,
        unit,
        ____exports.getEnergy(nil, unit) + amount,
        informClient
    )
    if showOverhead then
        ____exports.sendOverheadEnergyMessage(nil, unit, amount)
    end
end
local function getRecastModifiers(self, unit)
    return ModifierRecast:findAll(unit)
end
function ____exports.deactivateNonPriorityAbilities(self, unit)
    if IsServer() then
        do
            local i = 0
            while i <= 10 do
                local ability = unit:GetAbilityByIndex(i)
                if ability then
                    ability:SetActivated(false)
                end
                i = i + 1
            end
        end
    end
end
function ____exports.sendDataToClient(self, unit)
    if unit:IsRealHero() and not unit:IsIllusion() then
        local allianceName = "NOT_ALLIANCE"
        if CustomEntitiesLegacy:GetAlliance(unit) then
            allianceName = CustomEntitiesLegacy:GetAlliance(unit):GetName()
        end
        local data = {
            entityIndex = unit:GetEntityIndex(),
            teamId = unit:GetTeam(),
            playerId = unit:GetPlayerOwnerID(),
            allianceName = allianceName,
            name = unit:GetName(),
            health = unit:GetHealth(),
            maxHealth = unit:GetMaxHealth(),
            mana = unit:GetMana(),
            maxMana = unit:GetMaxMana()
        }
        CustomNetTables:SetTableValue(
            "units",
            tostring(unit:GetPlayerID()),
            data
        )
    else
        if unit:IsIllusion() then
            return
        end
        local data = {
            playerId = nil,
            entityIndex = unit:GetEntityIndex(),
            teamId = unit:GetTeam(),
            health = unit:GetHealth(),
            maxHealth = unit:GetMaxHealth()
        }
        CustomNetTables:SetTableValue(
            "units",
            tostring("_" .. tostring(unit:GetEntityIndex())),
            data
        )
    end
end
function ____exports.clamp(self, value, max, min)
    if max and value > max then
        return max
    end
    if min and value < min then
        return min
    end
    return value
end
function ____exports.sendOverheadShieldMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(255, 255, 255)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        7
    )
end
function ____exports.sendOverheadManaMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(27, 113, 230)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        0
    )
end
function ____exports.getMaxEnergy(self, unit)
    return 0
end
function ____exports.giveMana(self, unit, amount, informClient, showOverhead)
    if unit:HasModifier("modifier_sapphire") then
        amount = amount * 2
    end
    unit:GiveMana(amount)
    if informClient then
        ____exports.sendDataToClient(nil, unit)
    end
    if showOverhead then
        ____exports.sendOverheadManaMessage(nil, unit, amount)
    end
end
function ____exports.giveManaPercent(self, unit, percentage, informClient, showOverhead)
    local mana = unit:GetMaxMana() * percentage / 100
    ____exports.giveMana(
        nil,
        unit,
        mana,
        informClient,
        showOverhead
    )
end
function ____exports.giveEnergyPercent(self, unit, percentage, informClient, showOverhead)
    local energy = ____exports.getMaxEnergy(nil, unit) * percentage / 100
    ____exports.giveEnergy(
        nil,
        unit,
        energy,
        informClient,
        showOverhead
    )
end
function ____exports.giveManaAndEnergyPercent(self, unit, percentage, informClient, showOverhead)
    if showOverhead == nil then
        showOverhead = true
    end
    ____exports.giveManaPercent(
        nil,
        unit,
        percentage,
        false,
        showOverhead
    )
    ____exports.giveEnergyPercent(
        nil,
        unit,
        percentage,
        false,
        showOverhead
    )
    if informClient then
    end
end
function ____exports.giveManaAndEnergy(self, unit, amount, informClient, showOverhead)
    if showOverhead == nil then
        showOverhead = true
    end
    ____exports.giveEnergy(
        nil,
        unit,
        amount,
        false,
        showOverhead
    )
    ____exports.giveMana(
        nil,
        unit,
        amount,
        false,
        showOverhead
    )
    if informClient then
    end
end
function ____exports.replenishEFX(self, target)
    local origin = target:GetAbsOrigin()
    local particleId = ParticleManager:CreateParticle("particles/units/heroes/hero_wisp/wisp_death.vpcf", PATTACH_CUSTOMORIGIN, target)
    ParticleManager:SetParticleControlEnt(
        particleId,
        0,
        target,
        PATTACH_POINT_FOLLOW,
        "attach_attack1",
        origin,
        true
    )
    ParticleManager:ReleaseParticleIndex(particleId)
end
function ____exports.clampPosition(self, origin, target, options)
    local direction = target:__sub(origin):Normalized()
    local distance = target:__sub(origin):Length2D()
    local result = target
    if options and options.maxRange and distance > (options and options.maxRange) then
        result = direction:__mul(options and options.maxRange):__add(origin)
    end
    if options and options.minRange and distance < options.minRange then
        result = direction:__mul(options and options.minRange):__add(origin)
    end
    return result
end
function ____exports.direction2D(self, from, to)
    return Vector(to.x - from.x, to.y - from.y, 0):Normalized()
end
function ____exports.meeleEFX(self, caster, direction, radius, color)
    local origin = caster:GetAbsOrigin()
    local efx = EFX(
        "particles/juggernaut/juggernaut_basic_attack_parent.vpcf",
        PATTACH_WORLDORIGIN,
        nil,
        {
            cp0 = origin,
            cp0f = direction,
            cp3 = Vector(radius, 0, 0)
        }
    )
    if color then
        ParticleManager:SetParticleControl(efx, 60, color)
        ParticleManager:SetParticleControl(
            efx,
            61,
            Vector(1, 0, 0)
        )
    end
    ParticleManager:ReleaseParticleIndex(efx)
    EFX("particles/juggernaut/juggernaut_basic_attack_dust.vpcf", PATTACH_ABSORIGIN_FOLLOW, caster, {release = true})
    if radius > 300 then
        ____exports.meeleEFX(
            nil,
            caster,
            direction,
            200,
            color
        )
    end
end
function ____exports.isConsideredWall(self, unit)
    return ModifierWall:findOne(unit)
end
function ____exports.isObstacle(self, unit)
    return ModifierObstacle:findOne(unit)
end
function ____exports.isGem(self, unit)
    return ModifierGem:findOne(unit)
end
function ____exports.isCountering(self, unit)
    return __TS__ArraySome(
        unit:FindAllModifiers(),
        function(____, modifier) return __TS__InstanceOf(modifier, ModifierCounter) end
    )
end
function ____exports.attackWithBaseDamage(self, options)
    local preAttackDamage = 0
    local multiplier = options.multiplier or 1
    local damageType = options.damageType or DAMAGE_TYPE_PHYSICAL
    ApplyDamage({
        victim = options.target,
        attacker = options.source,
        damage = math.floor((options.source:GetAverageTrueAttackDamage(options.target) + preAttackDamage) * multiplier),
        damage_type = damageType,
        ability = options.ability
    })
end
function ____exports.callEntityFuncSafe(self, entity, key)
    do
        local function ____catch(____error)
            print(____error)
        end
        local ____try, ____hasReturned = pcall(function()
            entity[key](entity)
        end)
        if not ____try then
            ____catch(____hasReturned)
        end
    end
end
local function isDisplacing(self, unit)
    for ____, modifier in ipairs(unit:FindAllModifiers()) do
        if __TS__InstanceOf(modifier, CustomModifierMotionHorizontal) or __TS__InstanceOf(modifier, CustomModifierMotionVertical) or __TS__InstanceOf(modifier, CustomModifierMotionBoth) then
            return true
        end
    end
    return false
end
function ____exports.fullyFaceTowards(self, unit, direction)
    if not isDisplacing(nil, unit) then
        unit:SetForwardVector(direction)
        unit:FaceTowards(unit:GetAbsOrigin():__add(direction))
    end
end
function ____exports.strongPurge(self, unit)
    unit:Purge(
        false,
        true,
        false,
        true,
        false
    )
end
function ____exports.hideHealthBar(self, unit, duration)
    ModifierHideBar:apply(unit, unit, nil, {duration = duration})
end
function ____exports.unhideHealthBar(self, unit)
    unit:RemoveModifierByName(ModifierHideBar.name)
end
local function radiusMarkerEfx(self, particleId, origin, radius, color, duration)
    ParticleManager:SetParticleControl(particleId, 0, origin)
    ParticleManager:SetParticleControl(
        particleId,
        1,
        Vector(radius, 1, 1)
    )
    ParticleManager:SetParticleControl(particleId, 2, color)
    ParticleManager:SetParticleControl(
        particleId,
        3,
        Vector(duration, 0, 0)
    )
    ParticleManager:ReleaseParticleIndex(particleId)
end
function ____exports.createRadiusMarker(self, unit, origin, radius, scope, duration)
    local red = Vector(255, 1, 1)
    local green = Vector(1, 255, 1)
    if scope == "public" then
        for ____, alliance in ipairs(GameRules.Addon.alliances) do
            for ____, team in ipairs(alliance.teams) do
                local color = unit:GetTeamNumber() == team and green or red
                radiusMarkerEfx(
                    nil,
                    ParticleManager:CreateParticleForTeam("particles/aoe_marker.vpcf", PATTACH_WORLDORIGIN, nil, team),
                    origin,
                    radius,
                    color,
                    duration
                )
            end
        end
        return
    end
    radiusMarkerEfx(
        nil,
        ParticleManager:CreateParticleForPlayer(
            "particles/aoe_marker.vpcf",
            PATTACH_WORLDORIGIN,
            nil,
            unit:GetPlayerOwner()
        ),
        origin,
        radius,
        green,
        duration
    )
end
function ____exports.randomInArray(self, array)
    return array[RandomInt(0, #array - 1) + 1]
end
function ____exports.createTimedRadiusMarker(self, caster, origin, radius, delay, duration, scope)
    local ____, modifier = unpack(ModifierRadiusMarker:createThinker(caster, nil, origin, {afterDelay = duration, radius = radius, delay = delay, scope = scope}))
    return {destroy = function() return modifier and modifier:Destroy() end}
end
function ____exports.lock(self)
    return {locked = false}
end
function ____exports.tryLock(self, lock, thenDo, orElse)
    if lock.locked then
        return orElse
    else
        lock.locked = true
        local value = thenDo(nil)
        lock.locked = false
        return value
    end
end
return ____exports
