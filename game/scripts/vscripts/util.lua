local ____lualib = require("lualib_bundle")
local __TS__InstanceOf = ____lualib.__TS__InstanceOf
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["6"] = 1,["7"] = 2,["8"] = 3,["9"] = 4,["10"] = 6,["11"] = 6,["12"] = 7,["13"] = 7,["14"] = 8,["15"] = 8,["16"] = 9,["17"] = 9,["18"] = 77,["19"] = 78,["20"] = 80,["21"] = 80,["22"] = 80,["23"] = 80,["24"] = 80,["25"] = 80,["26"] = 80,["27"] = 80,["28"] = 80,["29"] = 80,["30"] = 80,["31"] = 80,["32"] = 77,["33"] = 89,["34"] = 90,["35"] = 91,["36"] = 93,["37"] = 93,["38"] = 93,["39"] = 93,["40"] = 93,["41"] = 93,["42"] = 93,["43"] = 93,["44"] = 89,["45"] = 108,["46"] = 112,["48"] = 108,["49"] = 117,["50"] = 119,["51"] = 117,["52"] = 151,["53"] = 156,["54"] = 156,["55"] = 156,["56"] = 156,["57"] = 156,["58"] = 156,["59"] = 158,["60"] = 159,["62"] = 151,["63"] = 11,["64"] = 12,["65"] = 11,["66"] = 15,["67"] = 16,["68"] = 17,["69"] = 19,["70"] = 20,["72"] = 24,["73"] = 24,["74"] = 24,["75"] = 24,["76"] = 24,["77"] = 24,["78"] = 24,["79"] = 24,["80"] = 24,["81"] = 24,["82"] = 24,["83"] = 47,["84"] = 47,["85"] = 47,["86"] = 47,["87"] = 47,["89"] = 49,["92"] = 53,["93"] = 53,["94"] = 53,["95"] = 53,["96"] = 53,["97"] = 53,["98"] = 53,["99"] = 63,["100"] = 63,["101"] = 63,["102"] = 63,["103"] = 63,["105"] = 15,["106"] = 67,["107"] = 68,["108"] = 69,["110"] = 71,["111"] = 72,["113"] = 74,["114"] = 67,["115"] = 96,["116"] = 97,["117"] = 98,["118"] = 100,["119"] = 100,["120"] = 100,["121"] = 100,["122"] = 100,["123"] = 100,["124"] = 100,["125"] = 100,["126"] = 96,["127"] = 103,["128"] = 105,["129"] = 103,["130"] = 122,["131"] = 127,["132"] = 128,["134"] = 131,["135"] = 133,["136"] = 134,["138"] = 136,["139"] = 137,["141"] = 122,["142"] = 141,["143"] = 142,["144"] = 143,["145"] = 143,["146"] = 143,["147"] = 143,["148"] = 143,["149"] = 143,["150"] = 143,["151"] = 141,["152"] = 146,["153"] = 147,["154"] = 148,["155"] = 148,["156"] = 148,["157"] = 148,["158"] = 148,["159"] = 148,["160"] = 148,["161"] = 146,["162"] = 163,["163"] = 163,["164"] = 163,["166"] = 164,["167"] = 164,["168"] = 164,["169"] = 164,["170"] = 164,["171"] = 164,["172"] = 164,["173"] = 165,["174"] = 165,["175"] = 165,["176"] = 165,["177"] = 165,["178"] = 165,["179"] = 165,["180"] = 167,["182"] = 163,["183"] = 172,["184"] = 172,["185"] = 172,["187"] = 173,["188"] = 173,["189"] = 173,["190"] = 173,["191"] = 173,["192"] = 173,["193"] = 173,["194"] = 174,["195"] = 174,["196"] = 174,["197"] = 174,["198"] = 174,["199"] = 174,["200"] = 174,["201"] = 176,["203"] = 172,["204"] = 181,["205"] = 182,["206"] = 184,["207"] = 189,["208"] = 189,["209"] = 189,["210"] = 189,["211"] = 189,["212"] = 189,["213"] = 189,["214"] = 189,["215"] = 189,["216"] = 190,["217"] = 181,["218"] = 193,["219"] = 194,["220"] = 195,["221"] = 196,["222"] = 198,["223"] = 199,["225"] = 202,["226"] = 203,["228"] = 206,["229"] = 193,["230"] = 209,["231"] = 210,["232"] = 209,["233"] = 213,["234"] = 214,["235"] = 217,["236"] = 217,["237"] = 217,["238"] = 217,["239"] = 217,["240"] = 217,["241"] = 217,["242"] = 217,["243"] = 217,["244"] = 217,["245"] = 223,["246"] = 224,["247"] = 225,["248"] = 225,["249"] = 225,["250"] = 225,["251"] = 225,["253"] = 228,["254"] = 230,["255"] = 234,["256"] = 235,["257"] = 235,["258"] = 235,["259"] = 235,["260"] = 235,["261"] = 235,["262"] = 235,["264"] = 213,["265"] = 239,["266"] = 240,["267"] = 239,["268"] = 243,["269"] = 244,["270"] = 243,["271"] = 247,["272"] = 248,["273"] = 247,["274"] = 251,["275"] = 258,["276"] = 259,["277"] = 260,["278"] = 274,["279"] = 274,["280"] = 274,["281"] = 274,["282"] = 274,["283"] = 274,["284"] = 274,["285"] = 251,["286"] = 283,["289"] = 287,["292"] = 285,["298"] = 283,["299"] = 291,["300"] = 292,["301"] = 294,["302"] = 298,["305"] = 302,["306"] = 291,["307"] = 305,["308"] = 306,["309"] = 307,["310"] = 308,["312"] = 305,["313"] = 312,["314"] = 313,["315"] = 313,["316"] = 313,["317"] = 313,["318"] = 313,["319"] = 313,["320"] = 313,["321"] = 312});
local ____exports = {}
local ____custom_modifier = require("abilities.framework.custom_modifier")
local CustomModifierMotionBoth = ____custom_modifier.CustomModifierMotionBoth
local CustomModifierMotionHorizontal = ____custom_modifier.CustomModifierMotionHorizontal
local CustomModifierMotionVertical = ____custom_modifier.CustomModifierMotionVertical
local ____modifier_gem = require("modifiers.modifier_gem")
local ModifierGem = ____modifier_gem.ModifierGem
local ____modifier_obstacle = require("modifiers.modifier_obstacle")
local ModifierObstacle = ____modifier_obstacle.ModifierObstacle
local ____modifier_recast = require("modifiers.modifier_recast")
local ModifierRecast = ____modifier_recast.ModifierRecast
local ____modifier_wall = require("modifiers.modifier_wall")
local ModifierWall = ____modifier_wall.ModifierWall
function ____exports.overheadMessageEFX(self, unit, value, wordLength, color, shield)
    local duration = math.max(1, value / 10)
    EFX(
        "particles/msg_damage.vpcf",
        PATTACH_WORLDORIGIN,
        nil,
        {
            cp0 = unit:GetAbsOrigin(),
            cp1 = Vector(0, value, shield),
            cp2 = Vector(duration, wordLength, 0),
            cp3 = color,
            release = true
        }
    )
end
function ____exports.sendOverheadEnergyMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(255, 243, 140)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        0
    )
end
function ____exports.setEnergy(self, unit, amount, informClient)
    if informClient then
    end
end
function ____exports.getEnergy(self, unit)
    return 0
end
function ____exports.giveEnergy(self, unit, amount, informClient, showOverhead)
    ____exports.setEnergy(
        nil,
        unit,
        ____exports.getEnergy(nil, unit) + amount,
        informClient
    )
    if showOverhead then
        ____exports.sendOverheadEnergyMessage(nil, unit, amount)
    end
end
local function getRecastModifiers(self, unit)
    return ModifierRecast:findAll(unit)
end
function ____exports.sendDataToClient(self, unit)
    if unit:IsRealHero() and not unit:IsIllusion() then
        local allianceName = "NOT_ALLIANCE"
        if CustomEntitiesLegacy:GetAlliance(unit) then
            allianceName = CustomEntitiesLegacy:GetAlliance(unit):GetName()
        end
        local data = {
            entityIndex = unit:GetEntityIndex(),
            teamId = unit:GetTeam(),
            playerId = unit:GetPlayerOwnerID(),
            allianceName = allianceName,
            name = unit:GetName(),
            health = unit:GetHealth(),
            maxHealth = unit:GetMaxHealth(),
            mana = unit:GetMana(),
            maxMana = unit:GetMaxMana()
        }
        CustomNetTables:SetTableValue(
            "units",
            tostring(unit:GetPlayerID()),
            data
        )
    else
        if unit:IsIllusion() then
            return
        end
        local data = {
            playerId = nil,
            entityIndex = unit:GetEntityIndex(),
            teamId = unit:GetTeam(),
            health = unit:GetHealth(),
            maxHealth = unit:GetMaxHealth()
        }
        CustomNetTables:SetTableValue(
            "units",
            tostring("_" .. tostring(unit:GetEntityIndex())),
            data
        )
    end
end
function ____exports.clamp(self, value, max, min)
    if max and value > max then
        return max
    end
    if min and value < min then
        return min
    end
    return value
end
function ____exports.sendOverheadManaMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(27, 113, 230)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        0
    )
end
function ____exports.getMaxEnergy(self, unit)
    return 0
end
function ____exports.giveMana(self, unit, amount, informClient, showOverhead)
    if unit:HasModifier("modifier_sapphire") then
        amount = amount * 2
    end
    unit:GiveMana(amount)
    if informClient then
        ____exports.sendDataToClient(nil, unit)
    end
    if showOverhead then
        ____exports.sendOverheadManaMessage(nil, unit, amount)
    end
end
function ____exports.giveManaPercent(self, unit, percentage, informClient, showOverhead)
    local mana = unit:GetMaxMana() * percentage / 100
    ____exports.giveMana(
        nil,
        unit,
        mana,
        informClient,
        showOverhead
    )
end
function ____exports.giveEnergyPercent(self, unit, percentage, informClient, showOverhead)
    local energy = ____exports.getMaxEnergy(nil, unit) * percentage / 100
    ____exports.giveEnergy(
        nil,
        unit,
        energy,
        informClient,
        showOverhead
    )
end
function ____exports.giveManaAndEnergyPercent(self, unit, percentage, informClient, showOverhead)
    if showOverhead == nil then
        showOverhead = true
    end
    ____exports.giveManaPercent(
        nil,
        unit,
        percentage,
        false,
        showOverhead
    )
    ____exports.giveEnergyPercent(
        nil,
        unit,
        percentage,
        false,
        showOverhead
    )
    if informClient then
    end
end
function ____exports.giveManaAndEnergy(self, unit, amount, informClient, showOverhead)
    if showOverhead == nil then
        showOverhead = true
    end
    ____exports.giveEnergy(
        nil,
        unit,
        amount,
        false,
        showOverhead
    )
    ____exports.giveMana(
        nil,
        unit,
        amount,
        false,
        showOverhead
    )
    if informClient then
    end
end
function ____exports.replenishEFX(self, target)
    local origin = target:GetAbsOrigin()
    local particleId = ParticleManager:CreateParticle("particles/units/heroes/hero_wisp/wisp_death.vpcf", PATTACH_CUSTOMORIGIN, target)
    ParticleManager:SetParticleControlEnt(
        particleId,
        0,
        target,
        PATTACH_POINT_FOLLOW,
        "attach_attack1",
        origin,
        true
    )
    ParticleManager:ReleaseParticleIndex(particleId)
end
function ____exports.clampPosition(self, origin, target, options)
    local direction = target:__sub(origin):Normalized()
    local distance = target:__sub(origin):Length2D()
    local result = target
    if options and options.maxRange and distance > (options and options.maxRange) then
        result = direction:__mul(options and options.maxRange):__add(origin)
    end
    if options and options.minRange and distance < options.minRange then
        result = direction:__mul(options and options.minRange):__add(origin)
    end
    return result
end
function ____exports.direction2D(self, origin, target)
    return Vector(target.x - origin.x, target.y - origin.y, 0):Normalized()
end
function ____exports.meeleEFX(self, caster, direction, radius, color)
    local origin = caster:GetAbsOrigin()
    local efx = EFX(
        "particles/juggernaut/juggernaut_basic_attack_parent.vpcf",
        PATTACH_WORLDORIGIN,
        nil,
        {
            cp0 = origin,
            cp0f = direction,
            cp3 = Vector(radius, 0, 0)
        }
    )
    if color then
        ParticleManager:SetParticleControl(efx, 60, color)
        ParticleManager:SetParticleControl(
            efx,
            61,
            Vector(1, 0, 0)
        )
    end
    ParticleManager:ReleaseParticleIndex(efx)
    EFX("particles/juggernaut/juggernaut_basic_attack_dust.vpcf", PATTACH_ABSORIGIN_FOLLOW, caster, {release = true})
    if radius > 300 then
        ____exports.meeleEFX(
            nil,
            caster,
            direction,
            200,
            color
        )
    end
end
function ____exports.isConsideredWall(self, unit)
    return ModifierWall:findOne(unit)
end
function ____exports.isObstacle(self, unit)
    return ModifierObstacle:findOne(unit)
end
function ____exports.isGem(self, unit)
    return ModifierGem:findOne(unit)
end
function ____exports.attackWithBaseDamage(self, options)
    local preAttackDamage = 0
    local multiplier = options.multiplier or 1
    local damageType = options.damageType or DAMAGE_TYPE_PHYSICAL
    ApplyDamage({
        victim = options.target,
        attacker = options.source,
        damage = math.floor((options.source:GetAverageTrueAttackDamage(options.target) + preAttackDamage) * multiplier),
        damage_type = damageType,
        ability = options.ability
    })
end
function ____exports.callEntityFuncSafe(self, entity, key)
    do
        local function ____catch(____error)
            print(____error)
        end
        local ____try, ____hasReturned = pcall(function()
            entity[key](entity)
        end)
        if not ____try then
            ____catch(____hasReturned)
        end
    end
end
local function isDisplacing(self, unit)
    for ____, modifier in ipairs(unit:FindAllModifiers()) do
        if __TS__InstanceOf(modifier, CustomModifierMotionHorizontal) or __TS__InstanceOf(modifier, CustomModifierMotionVertical) or __TS__InstanceOf(modifier, CustomModifierMotionBoth) then
            return true
        end
    end
    return false
end
function ____exports.fullyFaceTowards(self, unit, direction)
    if not isDisplacing(nil, unit) then
        unit:SetForwardVector(direction)
        unit:FaceTowards(unit:GetAbsOrigin():__add(direction))
    end
end
function ____exports.strongPurge(self, unit)
    unit:Purge(
        false,
        true,
        false,
        true,
        false
    )
end
return ____exports
