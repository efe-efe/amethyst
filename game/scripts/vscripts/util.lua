local ____lualib = require("lualib_bundle")
local __TS__InstanceOf = ____lualib.__TS__InstanceOf
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["6"] = 1,["7"] = 2,["8"] = 3,["9"] = 4,["10"] = 6,["11"] = 6,["12"] = 7,["13"] = 7,["14"] = 8,["15"] = 8,["16"] = 9,["17"] = 9,["18"] = 10,["19"] = 10,["20"] = 11,["21"] = 11,["22"] = 95,["23"] = 96,["24"] = 98,["25"] = 98,["26"] = 98,["27"] = 98,["28"] = 98,["29"] = 98,["30"] = 98,["31"] = 98,["32"] = 98,["33"] = 98,["34"] = 98,["35"] = 98,["36"] = 95,["37"] = 114,["38"] = 115,["39"] = 116,["40"] = 118,["41"] = 118,["42"] = 118,["43"] = 118,["44"] = 118,["45"] = 118,["46"] = 118,["47"] = 118,["48"] = 114,["49"] = 133,["50"] = 137,["52"] = 133,["53"] = 142,["54"] = 144,["55"] = 142,["56"] = 176,["57"] = 181,["58"] = 181,["59"] = 181,["60"] = 181,["61"] = 181,["62"] = 181,["63"] = 183,["64"] = 184,["66"] = 176,["67"] = 13,["68"] = 14,["69"] = 13,["70"] = 18,["71"] = 19,["73"] = 21,["74"] = 21,["75"] = 22,["76"] = 24,["77"] = 26,["79"] = 21,["83"] = 18,["84"] = 33,["85"] = 34,["86"] = 35,["87"] = 37,["88"] = 38,["90"] = 42,["91"] = 42,["92"] = 42,["93"] = 42,["94"] = 42,["95"] = 42,["96"] = 42,["97"] = 42,["98"] = 42,["99"] = 42,["100"] = 42,["101"] = 65,["102"] = 65,["103"] = 65,["104"] = 65,["105"] = 65,["107"] = 67,["110"] = 71,["111"] = 71,["112"] = 71,["113"] = 71,["114"] = 71,["115"] = 71,["116"] = 71,["117"] = 81,["118"] = 81,["119"] = 81,["120"] = 81,["121"] = 81,["123"] = 33,["124"] = 85,["125"] = 86,["126"] = 87,["128"] = 89,["129"] = 90,["131"] = 92,["132"] = 85,["133"] = 107,["134"] = 108,["135"] = 109,["136"] = 111,["137"] = 111,["138"] = 111,["139"] = 111,["140"] = 111,["141"] = 111,["142"] = 111,["143"] = 111,["144"] = 107,["145"] = 121,["146"] = 122,["147"] = 123,["148"] = 125,["149"] = 125,["150"] = 125,["151"] = 125,["152"] = 125,["153"] = 125,["154"] = 125,["155"] = 125,["156"] = 121,["157"] = 128,["158"] = 130,["159"] = 128,["160"] = 147,["161"] = 152,["162"] = 153,["164"] = 156,["165"] = 158,["166"] = 159,["168"] = 161,["169"] = 162,["171"] = 147,["172"] = 166,["173"] = 167,["174"] = 168,["175"] = 168,["176"] = 168,["177"] = 168,["178"] = 168,["179"] = 168,["180"] = 168,["181"] = 166,["182"] = 171,["183"] = 172,["184"] = 173,["185"] = 173,["186"] = 173,["187"] = 173,["188"] = 173,["189"] = 173,["190"] = 173,["191"] = 171,["192"] = 188,["193"] = 188,["194"] = 188,["196"] = 189,["197"] = 189,["198"] = 189,["199"] = 189,["200"] = 189,["201"] = 189,["202"] = 189,["203"] = 190,["204"] = 190,["205"] = 190,["206"] = 190,["207"] = 190,["208"] = 190,["209"] = 190,["210"] = 192,["212"] = 188,["213"] = 197,["214"] = 197,["215"] = 197,["217"] = 198,["218"] = 198,["219"] = 198,["220"] = 198,["221"] = 198,["222"] = 198,["223"] = 198,["224"] = 199,["225"] = 199,["226"] = 199,["227"] = 199,["228"] = 199,["229"] = 199,["230"] = 199,["231"] = 201,["233"] = 197,["234"] = 206,["235"] = 207,["236"] = 209,["237"] = 214,["238"] = 214,["239"] = 214,["240"] = 214,["241"] = 214,["242"] = 214,["243"] = 214,["244"] = 214,["245"] = 214,["246"] = 215,["247"] = 206,["248"] = 218,["249"] = 219,["250"] = 220,["251"] = 221,["252"] = 223,["253"] = 224,["255"] = 227,["256"] = 228,["258"] = 231,["259"] = 218,["260"] = 234,["261"] = 235,["262"] = 234,["263"] = 238,["264"] = 239,["265"] = 242,["266"] = 242,["267"] = 242,["268"] = 242,["269"] = 242,["270"] = 242,["271"] = 242,["272"] = 242,["273"] = 242,["274"] = 242,["275"] = 248,["276"] = 249,["277"] = 250,["278"] = 250,["279"] = 250,["280"] = 250,["281"] = 250,["283"] = 253,["284"] = 255,["285"] = 259,["286"] = 260,["287"] = 260,["288"] = 260,["289"] = 260,["290"] = 260,["291"] = 260,["292"] = 260,["294"] = 238,["295"] = 264,["296"] = 265,["297"] = 264,["298"] = 268,["299"] = 269,["300"] = 268,["301"] = 272,["302"] = 273,["303"] = 272,["304"] = 276,["305"] = 283,["306"] = 284,["307"] = 285,["308"] = 299,["309"] = 299,["310"] = 299,["311"] = 299,["312"] = 299,["313"] = 299,["314"] = 299,["315"] = 276,["316"] = 308,["319"] = 312,["322"] = 310,["328"] = 308,["329"] = 316,["330"] = 317,["331"] = 319,["332"] = 323,["335"] = 327,["336"] = 316,["337"] = 330,["338"] = 331,["339"] = 332,["340"] = 333,["342"] = 330,["343"] = 337,["344"] = 338,["345"] = 338,["346"] = 338,["347"] = 338,["348"] = 338,["349"] = 338,["350"] = 338,["351"] = 337,["352"] = 341,["353"] = 342,["354"] = 341,["355"] = 345,["356"] = 346,["357"] = 345,["358"] = 349,["359"] = 350,["360"] = 351,["361"] = 351,["362"] = 351,["363"] = 351,["364"] = 351,["365"] = 352,["366"] = 353,["367"] = 353,["368"] = 353,["369"] = 353,["370"] = 353,["371"] = 354,["372"] = 349,["373"] = 357,["374"] = 358,["375"] = 359,["376"] = 361,["377"] = 362,["378"] = 363,["379"] = 364,["380"] = 365,["381"] = 365,["382"] = 365,["383"] = 365,["384"] = 365,["385"] = 365,["386"] = 365,["387"] = 365,["392"] = 377,["393"] = 377,["394"] = 378,["395"] = 378,["396"] = 378,["397"] = 378,["398"] = 378,["399"] = 377,["400"] = 377,["401"] = 377,["402"] = 377,["403"] = 377,["404"] = 377,["405"] = 357,["406"] = 391,["407"] = 392,["408"] = 391,["409"] = 396,["410"] = 404,["411"] = 411,["412"] = 396});
local ____exports = {}
local ____custom_modifier = require("abilities.framework.custom_modifier")
local CustomModifierMotionBoth = ____custom_modifier.CustomModifierMotionBoth
local CustomModifierMotionHorizontal = ____custom_modifier.CustomModifierMotionHorizontal
local CustomModifierMotionVertical = ____custom_modifier.CustomModifierMotionVertical
local ____modifier_gem = require("modifiers.modifier_gem")
local ModifierGem = ____modifier_gem.ModifierGem
local ____modifier_hide_bar = require("modifiers.modifier_hide_bar")
local ModifierHideBar = ____modifier_hide_bar.ModifierHideBar
local ____modifier_obstacle = require("modifiers.modifier_obstacle")
local ModifierObstacle = ____modifier_obstacle.ModifierObstacle
local ____modifier_radius_marker = require("modifiers.modifier_radius_marker")
local ModifierRadiusMarker = ____modifier_radius_marker.ModifierRadiusMarker
local ____modifier_recast = require("modifiers.modifier_recast")
local ModifierRecast = ____modifier_recast.ModifierRecast
local ____modifier_wall = require("modifiers.modifier_wall")
local ModifierWall = ____modifier_wall.ModifierWall
function ____exports.overheadMessageEFX(self, unit, value, wordLength, color, shield)
    local duration = math.max(1, value / 10)
    EFX(
        "particles/msg_damage.vpcf",
        PATTACH_WORLDORIGIN,
        nil,
        {
            cp0 = unit:GetAbsOrigin(),
            cp1 = Vector(0, value, shield),
            cp2 = Vector(duration, wordLength, 0),
            cp3 = color,
            release = true
        }
    )
end
function ____exports.sendOverheadEnergyMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(255, 243, 140)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        0
    )
end
function ____exports.setEnergy(self, unit, amount, informClient)
    if informClient then
    end
end
function ____exports.getEnergy(self, unit)
    return 0
end
function ____exports.giveEnergy(self, unit, amount, informClient, showOverhead)
    ____exports.setEnergy(
        nil,
        unit,
        ____exports.getEnergy(nil, unit) + amount,
        informClient
    )
    if showOverhead then
        ____exports.sendOverheadEnergyMessage(nil, unit, amount)
    end
end
local function getRecastModifiers(self, unit)
    return ModifierRecast:findAll(unit)
end
function ____exports.deactivateNonPriorityAbilities(self, unit)
    if IsServer() then
        do
            local i = 0
            while i <= 10 do
                local ability = unit:GetAbilityByIndex(i)
                if ability then
                    ability:SetActivated(false)
                end
                i = i + 1
            end
        end
    end
end
function ____exports.sendDataToClient(self, unit)
    if unit:IsRealHero() and not unit:IsIllusion() then
        local allianceName = "NOT_ALLIANCE"
        if CustomEntitiesLegacy:GetAlliance(unit) then
            allianceName = CustomEntitiesLegacy:GetAlliance(unit):GetName()
        end
        local data = {
            entityIndex = unit:GetEntityIndex(),
            teamId = unit:GetTeam(),
            playerId = unit:GetPlayerOwnerID(),
            allianceName = allianceName,
            name = unit:GetName(),
            health = unit:GetHealth(),
            maxHealth = unit:GetMaxHealth(),
            mana = unit:GetMana(),
            maxMana = unit:GetMaxMana()
        }
        CustomNetTables:SetTableValue(
            "units",
            tostring(unit:GetPlayerID()),
            data
        )
    else
        if unit:IsIllusion() then
            return
        end
        local data = {
            playerId = nil,
            entityIndex = unit:GetEntityIndex(),
            teamId = unit:GetTeam(),
            health = unit:GetHealth(),
            maxHealth = unit:GetMaxHealth()
        }
        CustomNetTables:SetTableValue(
            "units",
            tostring("_" .. tostring(unit:GetEntityIndex())),
            data
        )
    end
end
function ____exports.clamp(self, value, max, min)
    if max and value > max then
        return max
    end
    if min and value < min then
        return min
    end
    return value
end
function ____exports.sendOverheadShieldMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(255, 255, 255)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        7
    )
end
function ____exports.sendOverheadManaMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(27, 113, 230)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        0
    )
end
function ____exports.getMaxEnergy(self, unit)
    return 0
end
function ____exports.giveMana(self, unit, amount, informClient, showOverhead)
    if unit:HasModifier("modifier_sapphire") then
        amount = amount * 2
    end
    unit:GiveMana(amount)
    if informClient then
        ____exports.sendDataToClient(nil, unit)
    end
    if showOverhead then
        ____exports.sendOverheadManaMessage(nil, unit, amount)
    end
end
function ____exports.giveManaPercent(self, unit, percentage, informClient, showOverhead)
    local mana = unit:GetMaxMana() * percentage / 100
    ____exports.giveMana(
        nil,
        unit,
        mana,
        informClient,
        showOverhead
    )
end
function ____exports.giveEnergyPercent(self, unit, percentage, informClient, showOverhead)
    local energy = ____exports.getMaxEnergy(nil, unit) * percentage / 100
    ____exports.giveEnergy(
        nil,
        unit,
        energy,
        informClient,
        showOverhead
    )
end
function ____exports.giveManaAndEnergyPercent(self, unit, percentage, informClient, showOverhead)
    if showOverhead == nil then
        showOverhead = true
    end
    ____exports.giveManaPercent(
        nil,
        unit,
        percentage,
        false,
        showOverhead
    )
    ____exports.giveEnergyPercent(
        nil,
        unit,
        percentage,
        false,
        showOverhead
    )
    if informClient then
    end
end
function ____exports.giveManaAndEnergy(self, unit, amount, informClient, showOverhead)
    if showOverhead == nil then
        showOverhead = true
    end
    ____exports.giveEnergy(
        nil,
        unit,
        amount,
        false,
        showOverhead
    )
    ____exports.giveMana(
        nil,
        unit,
        amount,
        false,
        showOverhead
    )
    if informClient then
    end
end
function ____exports.replenishEFX(self, target)
    local origin = target:GetAbsOrigin()
    local particleId = ParticleManager:CreateParticle("particles/units/heroes/hero_wisp/wisp_death.vpcf", PATTACH_CUSTOMORIGIN, target)
    ParticleManager:SetParticleControlEnt(
        particleId,
        0,
        target,
        PATTACH_POINT_FOLLOW,
        "attach_attack1",
        origin,
        true
    )
    ParticleManager:ReleaseParticleIndex(particleId)
end
function ____exports.clampPosition(self, origin, target, options)
    local direction = target:__sub(origin):Normalized()
    local distance = target:__sub(origin):Length2D()
    local result = target
    if options and options.maxRange and distance > (options and options.maxRange) then
        result = direction:__mul(options and options.maxRange):__add(origin)
    end
    if options and options.minRange and distance < options.minRange then
        result = direction:__mul(options and options.minRange):__add(origin)
    end
    return result
end
function ____exports.direction2D(self, from, to)
    return Vector(to.x - from.x, to.y - from.y, 0):Normalized()
end
function ____exports.meeleEFX(self, caster, direction, radius, color)
    local origin = caster:GetAbsOrigin()
    local efx = EFX(
        "particles/juggernaut/juggernaut_basic_attack_parent.vpcf",
        PATTACH_WORLDORIGIN,
        nil,
        {
            cp0 = origin,
            cp0f = direction,
            cp3 = Vector(radius, 0, 0)
        }
    )
    if color then
        ParticleManager:SetParticleControl(efx, 60, color)
        ParticleManager:SetParticleControl(
            efx,
            61,
            Vector(1, 0, 0)
        )
    end
    ParticleManager:ReleaseParticleIndex(efx)
    EFX("particles/juggernaut/juggernaut_basic_attack_dust.vpcf", PATTACH_ABSORIGIN_FOLLOW, caster, {release = true})
    if radius > 300 then
        ____exports.meeleEFX(
            nil,
            caster,
            direction,
            200,
            color
        )
    end
end
function ____exports.isConsideredWall(self, unit)
    return ModifierWall:findOne(unit)
end
function ____exports.isObstacle(self, unit)
    return ModifierObstacle:findOne(unit)
end
function ____exports.isGem(self, unit)
    return ModifierGem:findOne(unit)
end
function ____exports.attackWithBaseDamage(self, options)
    local preAttackDamage = 0
    local multiplier = options.multiplier or 1
    local damageType = options.damageType or DAMAGE_TYPE_PHYSICAL
    ApplyDamage({
        victim = options.target,
        attacker = options.source,
        damage = math.floor((options.source:GetAverageTrueAttackDamage(options.target) + preAttackDamage) * multiplier),
        damage_type = damageType,
        ability = options.ability
    })
end
function ____exports.callEntityFuncSafe(self, entity, key)
    do
        local function ____catch(____error)
            print(____error)
        end
        local ____try, ____hasReturned = pcall(function()
            entity[key](entity)
        end)
        if not ____try then
            ____catch(____hasReturned)
        end
    end
end
local function isDisplacing(self, unit)
    for ____, modifier in ipairs(unit:FindAllModifiers()) do
        if __TS__InstanceOf(modifier, CustomModifierMotionHorizontal) or __TS__InstanceOf(modifier, CustomModifierMotionVertical) or __TS__InstanceOf(modifier, CustomModifierMotionBoth) then
            return true
        end
    end
    return false
end
function ____exports.fullyFaceTowards(self, unit, direction)
    if not isDisplacing(nil, unit) then
        unit:SetForwardVector(direction)
        unit:FaceTowards(unit:GetAbsOrigin():__add(direction))
    end
end
function ____exports.strongPurge(self, unit)
    unit:Purge(
        false,
        true,
        false,
        true,
        false
    )
end
function ____exports.hideHealthBar(self, unit, duration)
    ModifierHideBar:apply(unit, unit, nil, {duration = duration})
end
function ____exports.unhideHealthBar(self, unit)
    unit:RemoveModifierByName(ModifierHideBar.name)
end
local function radiusMarkerEfx(self, particleId, origin, radius, color, duration)
    ParticleManager:SetParticleControl(particleId, 0, origin)
    ParticleManager:SetParticleControl(
        particleId,
        1,
        Vector(radius, 1, 1)
    )
    ParticleManager:SetParticleControl(particleId, 2, color)
    ParticleManager:SetParticleControl(
        particleId,
        3,
        Vector(duration, 0, 0)
    )
    ParticleManager:ReleaseParticleIndex(particleId)
end
function ____exports.createRadiusMarker(self, unit, origin, radius, scope, duration)
    local red = Vector(255, 1, 1)
    local green = Vector(1, 255, 1)
    if scope == "public" then
        for ____, alliance in ipairs(GameRules.Addon.alliances) do
            for ____, team in ipairs(alliance.teams) do
                local color = unit:GetTeamNumber() == team and green or red
                radiusMarkerEfx(
                    nil,
                    ParticleManager:CreateParticleForTeam("particles/aoe_marker.vpcf", PATTACH_WORLDORIGIN, nil, team),
                    origin,
                    radius,
                    color,
                    duration
                )
            end
        end
        return
    end
    radiusMarkerEfx(
        nil,
        ParticleManager:CreateParticleForPlayer(
            "particles/aoe_marker.vpcf",
            PATTACH_WORLDORIGIN,
            nil,
            unit:GetPlayerOwner()
        ),
        origin,
        radius,
        green,
        duration
    )
end
function ____exports.randomInArray(self, array)
    return array[RandomInt(0, #array - 1) + 1]
end
function ____exports.createTimedRadiusMarker(self, caster, origin, radius, delay, duration, scope)
    local ____, modifier = unpack(ModifierRadiusMarker:createThinker(caster, nil, origin, {afterDelay = duration, radius = radius, delay = delay, scope = scope}))
    return {destroy = function() return modifier and modifier:Destroy() end}
end
return ____exports
