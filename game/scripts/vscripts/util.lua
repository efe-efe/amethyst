local ____lualib = require("lualib_bundle")
local __TS__InstanceOf = ____lualib.__TS__InstanceOf
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["6"] = 1,["7"] = 2,["8"] = 3,["9"] = 4,["10"] = 6,["11"] = 6,["12"] = 7,["13"] = 7,["14"] = 8,["15"] = 8,["16"] = 9,["17"] = 9,["18"] = 10,["19"] = 10,["20"] = 94,["21"] = 95,["22"] = 97,["23"] = 97,["24"] = 97,["25"] = 97,["26"] = 97,["27"] = 97,["28"] = 97,["29"] = 97,["30"] = 97,["31"] = 97,["32"] = 97,["33"] = 97,["34"] = 94,["35"] = 113,["36"] = 114,["37"] = 115,["38"] = 117,["39"] = 117,["40"] = 117,["41"] = 117,["42"] = 117,["43"] = 117,["44"] = 117,["45"] = 117,["46"] = 113,["47"] = 132,["48"] = 136,["50"] = 132,["51"] = 141,["52"] = 143,["53"] = 141,["54"] = 175,["55"] = 180,["56"] = 180,["57"] = 180,["58"] = 180,["59"] = 180,["60"] = 180,["61"] = 182,["62"] = 183,["64"] = 175,["65"] = 12,["66"] = 13,["67"] = 12,["68"] = 17,["69"] = 18,["71"] = 20,["72"] = 20,["73"] = 21,["74"] = 23,["75"] = 25,["77"] = 20,["81"] = 17,["82"] = 32,["83"] = 33,["84"] = 34,["85"] = 36,["86"] = 37,["88"] = 41,["89"] = 41,["90"] = 41,["91"] = 41,["92"] = 41,["93"] = 41,["94"] = 41,["95"] = 41,["96"] = 41,["97"] = 41,["98"] = 41,["99"] = 64,["100"] = 64,["101"] = 64,["102"] = 64,["103"] = 64,["105"] = 66,["108"] = 70,["109"] = 70,["110"] = 70,["111"] = 70,["112"] = 70,["113"] = 70,["114"] = 70,["115"] = 80,["116"] = 80,["117"] = 80,["118"] = 80,["119"] = 80,["121"] = 32,["122"] = 84,["123"] = 85,["124"] = 86,["126"] = 88,["127"] = 89,["129"] = 91,["130"] = 84,["131"] = 106,["132"] = 107,["133"] = 108,["134"] = 110,["135"] = 110,["136"] = 110,["137"] = 110,["138"] = 110,["139"] = 110,["140"] = 110,["141"] = 110,["142"] = 106,["143"] = 120,["144"] = 121,["145"] = 122,["146"] = 124,["147"] = 124,["148"] = 124,["149"] = 124,["150"] = 124,["151"] = 124,["152"] = 124,["153"] = 124,["154"] = 120,["155"] = 127,["156"] = 129,["157"] = 127,["158"] = 146,["159"] = 151,["160"] = 152,["162"] = 155,["163"] = 157,["164"] = 158,["166"] = 160,["167"] = 161,["169"] = 146,["170"] = 165,["171"] = 166,["172"] = 167,["173"] = 167,["174"] = 167,["175"] = 167,["176"] = 167,["177"] = 167,["178"] = 167,["179"] = 165,["180"] = 170,["181"] = 171,["182"] = 172,["183"] = 172,["184"] = 172,["185"] = 172,["186"] = 172,["187"] = 172,["188"] = 172,["189"] = 170,["190"] = 187,["191"] = 187,["192"] = 187,["194"] = 188,["195"] = 188,["196"] = 188,["197"] = 188,["198"] = 188,["199"] = 188,["200"] = 188,["201"] = 189,["202"] = 189,["203"] = 189,["204"] = 189,["205"] = 189,["206"] = 189,["207"] = 189,["208"] = 191,["210"] = 187,["211"] = 196,["212"] = 196,["213"] = 196,["215"] = 197,["216"] = 197,["217"] = 197,["218"] = 197,["219"] = 197,["220"] = 197,["221"] = 197,["222"] = 198,["223"] = 198,["224"] = 198,["225"] = 198,["226"] = 198,["227"] = 198,["228"] = 198,["229"] = 200,["231"] = 196,["232"] = 205,["233"] = 206,["234"] = 208,["235"] = 213,["236"] = 213,["237"] = 213,["238"] = 213,["239"] = 213,["240"] = 213,["241"] = 213,["242"] = 213,["243"] = 213,["244"] = 214,["245"] = 205,["246"] = 217,["247"] = 218,["248"] = 219,["249"] = 220,["250"] = 222,["251"] = 223,["253"] = 226,["254"] = 227,["256"] = 230,["257"] = 217,["258"] = 233,["259"] = 234,["260"] = 233,["261"] = 237,["262"] = 238,["263"] = 241,["264"] = 241,["265"] = 241,["266"] = 241,["267"] = 241,["268"] = 241,["269"] = 241,["270"] = 241,["271"] = 241,["272"] = 241,["273"] = 247,["274"] = 248,["275"] = 249,["276"] = 249,["277"] = 249,["278"] = 249,["279"] = 249,["281"] = 252,["282"] = 254,["283"] = 258,["284"] = 259,["285"] = 259,["286"] = 259,["287"] = 259,["288"] = 259,["289"] = 259,["290"] = 259,["292"] = 237,["293"] = 263,["294"] = 264,["295"] = 263,["296"] = 267,["297"] = 268,["298"] = 267,["299"] = 271,["300"] = 272,["301"] = 271,["302"] = 275,["303"] = 282,["304"] = 283,["305"] = 284,["306"] = 298,["307"] = 298,["308"] = 298,["309"] = 298,["310"] = 298,["311"] = 298,["312"] = 298,["313"] = 275,["314"] = 307,["317"] = 311,["320"] = 309,["326"] = 307,["327"] = 315,["328"] = 316,["329"] = 318,["330"] = 322,["333"] = 326,["334"] = 315,["335"] = 329,["336"] = 330,["337"] = 331,["338"] = 332,["340"] = 329,["341"] = 336,["342"] = 337,["343"] = 337,["344"] = 337,["345"] = 337,["346"] = 337,["347"] = 337,["348"] = 337,["349"] = 336,["350"] = 340,["351"] = 341,["352"] = 340,["353"] = 344,["354"] = 345,["355"] = 344,["356"] = 348,["357"] = 349,["358"] = 350,["359"] = 350,["360"] = 350,["361"] = 350,["362"] = 350,["363"] = 351,["364"] = 352,["365"] = 352,["366"] = 352,["367"] = 352,["368"] = 352,["369"] = 353,["370"] = 348,["371"] = 356,["372"] = 357,["373"] = 358,["374"] = 360,["375"] = 361,["376"] = 362,["377"] = 363,["378"] = 364,["379"] = 364,["380"] = 364,["381"] = 364,["382"] = 364,["383"] = 364,["384"] = 364,["385"] = 364,["390"] = 376,["391"] = 376,["392"] = 377,["393"] = 377,["394"] = 377,["395"] = 377,["396"] = 377,["397"] = 376,["398"] = 376,["399"] = 376,["400"] = 376,["401"] = 376,["402"] = 376,["403"] = 356,["404"] = 390,["405"] = 391,["406"] = 390});
local ____exports = {}
local ____custom_modifier = require("abilities.framework.custom_modifier")
local CustomModifierMotionBoth = ____custom_modifier.CustomModifierMotionBoth
local CustomModifierMotionHorizontal = ____custom_modifier.CustomModifierMotionHorizontal
local CustomModifierMotionVertical = ____custom_modifier.CustomModifierMotionVertical
local ____modifier_gem = require("modifiers.modifier_gem")
local ModifierGem = ____modifier_gem.ModifierGem
local ____modifier_hide_bar = require("modifiers.modifier_hide_bar")
local ModifierHideBar = ____modifier_hide_bar.ModifierHideBar
local ____modifier_obstacle = require("modifiers.modifier_obstacle")
local ModifierObstacle = ____modifier_obstacle.ModifierObstacle
local ____modifier_recast = require("modifiers.modifier_recast")
local ModifierRecast = ____modifier_recast.ModifierRecast
local ____modifier_wall = require("modifiers.modifier_wall")
local ModifierWall = ____modifier_wall.ModifierWall
function ____exports.overheadMessageEFX(self, unit, value, wordLength, color, shield)
    local duration = math.max(1, value / 10)
    EFX(
        "particles/msg_damage.vpcf",
        PATTACH_WORLDORIGIN,
        nil,
        {
            cp0 = unit:GetAbsOrigin(),
            cp1 = Vector(0, value, shield),
            cp2 = Vector(duration, wordLength, 0),
            cp3 = color,
            release = true
        }
    )
end
function ____exports.sendOverheadEnergyMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(255, 243, 140)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        0
    )
end
function ____exports.setEnergy(self, unit, amount, informClient)
    if informClient then
    end
end
function ____exports.getEnergy(self, unit)
    return 0
end
function ____exports.giveEnergy(self, unit, amount, informClient, showOverhead)
    ____exports.setEnergy(
        nil,
        unit,
        ____exports.getEnergy(nil, unit) + amount,
        informClient
    )
    if showOverhead then
        ____exports.sendOverheadEnergyMessage(nil, unit, amount)
    end
end
local function getRecastModifiers(self, unit)
    return ModifierRecast:findAll(unit)
end
function ____exports.deactivateNonPriorityAbilities(self, unit)
    if IsServer() then
        do
            local i = 0
            while i <= 10 do
                local ability = unit:GetAbilityByIndex(i)
                if ability then
                    ability:SetActivated(false)
                end
                i = i + 1
            end
        end
    end
end
function ____exports.sendDataToClient(self, unit)
    if unit:IsRealHero() and not unit:IsIllusion() then
        local allianceName = "NOT_ALLIANCE"
        if CustomEntitiesLegacy:GetAlliance(unit) then
            allianceName = CustomEntitiesLegacy:GetAlliance(unit):GetName()
        end
        local data = {
            entityIndex = unit:GetEntityIndex(),
            teamId = unit:GetTeam(),
            playerId = unit:GetPlayerOwnerID(),
            allianceName = allianceName,
            name = unit:GetName(),
            health = unit:GetHealth(),
            maxHealth = unit:GetMaxHealth(),
            mana = unit:GetMana(),
            maxMana = unit:GetMaxMana()
        }
        CustomNetTables:SetTableValue(
            "units",
            tostring(unit:GetPlayerID()),
            data
        )
    else
        if unit:IsIllusion() then
            return
        end
        local data = {
            playerId = nil,
            entityIndex = unit:GetEntityIndex(),
            teamId = unit:GetTeam(),
            health = unit:GetHealth(),
            maxHealth = unit:GetMaxHealth()
        }
        CustomNetTables:SetTableValue(
            "units",
            tostring("_" .. tostring(unit:GetEntityIndex())),
            data
        )
    end
end
function ____exports.clamp(self, value, max, min)
    if max and value > max then
        return max
    end
    if min and value < min then
        return min
    end
    return value
end
function ____exports.sendOverheadShieldMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(255, 255, 255)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        7
    )
end
function ____exports.sendOverheadManaMessage(self, unit, value)
    local wordLength = string.len(tostring(math.floor(value))) + 1
    local color = Vector(27, 113, 230)
    ____exports.overheadMessageEFX(
        nil,
        unit,
        value,
        wordLength,
        color,
        0
    )
end
function ____exports.getMaxEnergy(self, unit)
    return 0
end
function ____exports.giveMana(self, unit, amount, informClient, showOverhead)
    if unit:HasModifier("modifier_sapphire") then
        amount = amount * 2
    end
    unit:GiveMana(amount)
    if informClient then
        ____exports.sendDataToClient(nil, unit)
    end
    if showOverhead then
        ____exports.sendOverheadManaMessage(nil, unit, amount)
    end
end
function ____exports.giveManaPercent(self, unit, percentage, informClient, showOverhead)
    local mana = unit:GetMaxMana() * percentage / 100
    ____exports.giveMana(
        nil,
        unit,
        mana,
        informClient,
        showOverhead
    )
end
function ____exports.giveEnergyPercent(self, unit, percentage, informClient, showOverhead)
    local energy = ____exports.getMaxEnergy(nil, unit) * percentage / 100
    ____exports.giveEnergy(
        nil,
        unit,
        energy,
        informClient,
        showOverhead
    )
end
function ____exports.giveManaAndEnergyPercent(self, unit, percentage, informClient, showOverhead)
    if showOverhead == nil then
        showOverhead = true
    end
    ____exports.giveManaPercent(
        nil,
        unit,
        percentage,
        false,
        showOverhead
    )
    ____exports.giveEnergyPercent(
        nil,
        unit,
        percentage,
        false,
        showOverhead
    )
    if informClient then
    end
end
function ____exports.giveManaAndEnergy(self, unit, amount, informClient, showOverhead)
    if showOverhead == nil then
        showOverhead = true
    end
    ____exports.giveEnergy(
        nil,
        unit,
        amount,
        false,
        showOverhead
    )
    ____exports.giveMana(
        nil,
        unit,
        amount,
        false,
        showOverhead
    )
    if informClient then
    end
end
function ____exports.replenishEFX(self, target)
    local origin = target:GetAbsOrigin()
    local particleId = ParticleManager:CreateParticle("particles/units/heroes/hero_wisp/wisp_death.vpcf", PATTACH_CUSTOMORIGIN, target)
    ParticleManager:SetParticleControlEnt(
        particleId,
        0,
        target,
        PATTACH_POINT_FOLLOW,
        "attach_attack1",
        origin,
        true
    )
    ParticleManager:ReleaseParticleIndex(particleId)
end
function ____exports.clampPosition(self, origin, target, options)
    local direction = target:__sub(origin):Normalized()
    local distance = target:__sub(origin):Length2D()
    local result = target
    if options and options.maxRange and distance > (options and options.maxRange) then
        result = direction:__mul(options and options.maxRange):__add(origin)
    end
    if options and options.minRange and distance < options.minRange then
        result = direction:__mul(options and options.minRange):__add(origin)
    end
    return result
end
function ____exports.direction2D(self, from, to)
    return Vector(to.x - from.x, to.y - from.y, 0):Normalized()
end
function ____exports.meeleEFX(self, caster, direction, radius, color)
    local origin = caster:GetAbsOrigin()
    local efx = EFX(
        "particles/juggernaut/juggernaut_basic_attack_parent.vpcf",
        PATTACH_WORLDORIGIN,
        nil,
        {
            cp0 = origin,
            cp0f = direction,
            cp3 = Vector(radius, 0, 0)
        }
    )
    if color then
        ParticleManager:SetParticleControl(efx, 60, color)
        ParticleManager:SetParticleControl(
            efx,
            61,
            Vector(1, 0, 0)
        )
    end
    ParticleManager:ReleaseParticleIndex(efx)
    EFX("particles/juggernaut/juggernaut_basic_attack_dust.vpcf", PATTACH_ABSORIGIN_FOLLOW, caster, {release = true})
    if radius > 300 then
        ____exports.meeleEFX(
            nil,
            caster,
            direction,
            200,
            color
        )
    end
end
function ____exports.isConsideredWall(self, unit)
    return ModifierWall:findOne(unit)
end
function ____exports.isObstacle(self, unit)
    return ModifierObstacle:findOne(unit)
end
function ____exports.isGem(self, unit)
    return ModifierGem:findOne(unit)
end
function ____exports.attackWithBaseDamage(self, options)
    local preAttackDamage = 0
    local multiplier = options.multiplier or 1
    local damageType = options.damageType or DAMAGE_TYPE_PHYSICAL
    ApplyDamage({
        victim = options.target,
        attacker = options.source,
        damage = math.floor((options.source:GetAverageTrueAttackDamage(options.target) + preAttackDamage) * multiplier),
        damage_type = damageType,
        ability = options.ability
    })
end
function ____exports.callEntityFuncSafe(self, entity, key)
    do
        local function ____catch(____error)
            print(____error)
        end
        local ____try, ____hasReturned = pcall(function()
            entity[key](entity)
        end)
        if not ____try then
            ____catch(____hasReturned)
        end
    end
end
local function isDisplacing(self, unit)
    for ____, modifier in ipairs(unit:FindAllModifiers()) do
        if __TS__InstanceOf(modifier, CustomModifierMotionHorizontal) or __TS__InstanceOf(modifier, CustomModifierMotionVertical) or __TS__InstanceOf(modifier, CustomModifierMotionBoth) then
            return true
        end
    end
    return false
end
function ____exports.fullyFaceTowards(self, unit, direction)
    if not isDisplacing(nil, unit) then
        unit:SetForwardVector(direction)
        unit:FaceTowards(unit:GetAbsOrigin():__add(direction))
    end
end
function ____exports.strongPurge(self, unit)
    unit:Purge(
        false,
        true,
        false,
        true,
        false
    )
end
function ____exports.hideHealthBar(self, unit, duration)
    ModifierHideBar:apply(unit, unit, nil, {duration = duration})
end
function ____exports.unhideHealthBar(self, unit)
    unit:RemoveModifierByName(ModifierHideBar.name)
end
local function radiusMarkerEfx(self, particleId, origin, radius, color, duration)
    ParticleManager:SetParticleControl(particleId, 0, origin)
    ParticleManager:SetParticleControl(
        particleId,
        1,
        Vector(radius, 1, 1)
    )
    ParticleManager:SetParticleControl(particleId, 2, color)
    ParticleManager:SetParticleControl(
        particleId,
        3,
        Vector(duration, 0, 0)
    )
    ParticleManager:ReleaseParticleIndex(particleId)
end
function ____exports.createRadiusMarker(self, unit, origin, radius, scope, duration)
    local red = Vector(255, 1, 1)
    local green = Vector(1, 255, 1)
    if scope == "public" then
        for ____, alliance in ipairs(GameRules.Addon.alliances) do
            for ____, team in ipairs(alliance.teams) do
                local color = unit:GetTeamNumber() == team and green or red
                radiusMarkerEfx(
                    nil,
                    ParticleManager:CreateParticleForTeam("particles/aoe_marker.vpcf", PATTACH_WORLDORIGIN, nil, team),
                    origin,
                    radius,
                    color,
                    duration
                )
            end
        end
        return
    end
    radiusMarkerEfx(
        nil,
        ParticleManager:CreateParticleForPlayer(
            "particles/aoe_marker.vpcf",
            PATTACH_WORLDORIGIN,
            nil,
            unit:GetPlayerOwner()
        ),
        origin,
        radius,
        green,
        duration
    )
end
function ____exports.randomInArray(self, array)
    return array[RandomInt(0, #array - 1) + 1]
end
return ____exports
